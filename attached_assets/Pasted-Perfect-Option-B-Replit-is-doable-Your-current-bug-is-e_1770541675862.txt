Perfect — **Option B + Replit** is doable. Your current bug is exactly this:

* You *start* an SSH tunnel on `localhost:9000`
* But your code still calls `https://stg.api.uwm.com/...` directly
* Cloudflare blocks (because Replit IP isn’t whitelisted) → you get the HTML “OOPS!” page

So we’ll make **all UWM calls go through the tunnel** *and* handle TLS correctly (cert is for `stg.api.uwm.com`, but the URL host is `localhost`).

Below are **precise edits** for your project.

---

## 1) Update the SSH tunnel command (server/index.ts)

Find this block in `server/index.ts`:

```ts
const sshCmd = "ssh -i .ssh/valargen-staging_key.pem -o StrictHostKeyChecking=no -N -L 9000:uwm.internal.api:443 vg-stg-user@4.227.184.143";
```

Replace it with this (configurable, and forwards to `stg.api.uwm.com:443`):

```ts
const sshKeyPath = process.env.SSH_KEY_PATH || ".ssh/valargen-staging_key.pem";
const sshUser = process.env.SSH_USER || "vg-stg-user";
const sshHost = process.env.SSH_HOST || "4.227.184.143";
const localPort = process.env.UWM_TUNNEL_LOCAL_PORT || "9000";

const sshCmd = `ssh -i ${sshKeyPath} -o StrictHostKeyChecking=no -N -L ${localPort}:stg.api.uwm.com:443 ${sshUser}@${sshHost}`;
```

✅ Now your tunnel is explicitly: `localhost:9000 -> stg.api.uwm.com:443 (from Azure VM)`

---

## 2) Route *all* UWM fetch calls through the tunnel (server/routes.ts)

### 2.1 Add imports at the top

Add these imports:

```ts
import { Agent as UndiciAgent } from "undici";
import tls from "tls";
```

### 2.2 Add a tunnel-aware `uwmFetch()` helper (inside `registerRoutes`, near the top)

Right after:

```ts
): Promise<Server> {
```

paste this:

```ts
// ---- UWM routing (direct vs SSH tunnel) ----
const UWM_DIRECT_BASE_URL = process.env.UWM_DIRECT_BASE_URL || "https://stg.api.uwm.com";
const UWM_TUNNEL_BASE_URL = process.env.UWM_TUNNEL_BASE_URL || "https://localhost:9000";
const USE_UWM_TUNNEL = process.env.USE_UWM_TUNNEL === "true";

// When using an SSH local forward, TLS cert is for stg.api.uwm.com but the URL host is localhost.
// This preserves TLS verification by validating the cert against stg.api.uwm.com.
const uwmTunnelDispatcher = new UndiciAgent({
  connect: {
    servername: "stg.api.uwm.com",
    checkServerIdentity: (_host: string, cert: any) =>
      tls.checkServerIdentity("stg.api.uwm.com", cert),
  },
});

const UWM_BASE_URL = USE_UWM_TUNNEL ? UWM_TUNNEL_BASE_URL : UWM_DIRECT_BASE_URL;

function uwmFetch(path: string, init: any = {}) {
  const url = path.startsWith("http") ? path : `${UWM_BASE_URL}${path}`;
  return fetch(url, {
    ...init,
    ...(USE_UWM_TUNNEL ? { dispatcher: uwmTunnelDispatcher } : {}),
  });
}
```

### 2.3 Replace every UWM fetch URL with `uwmFetch("/path")`

Change these:

```ts
fetch("https://stg.api.uwm.com/adfs/oauth2/token", ...)
fetch("https://stg.api.uwm.com/instantpricequote/v1/mortgagepricinglayout", ...)
fetch("https://stg.api.uwm.com/instantpricequote/v1/heloclayout", ...)
fetch("https://stg.api.uwm.com/instantpricequote/v1/pricequote", ...)
fetch("https://stg.api.uwm.com/instantpricequote/v1/helocquote", ...)
```

To:

```ts
uwmFetch("/adfs/oauth2/token", ...)
uwmFetch("/instantpricequote/v1/mortgagepricinglayout", ...)
uwmFetch("/instantpricequote/v1/heloclayout", ...)
uwmFetch("/instantpricequote/v1/pricequote", ...)
uwmFetch("/instantpricequote/v1/helocquote", ...)
```

✅ Now every call goes through your Azure VM tunnel, so UWM sees the whitelisted Azure IP.

---

## 3) Replit setup (this part matters)

### 3.1 Add Secrets / Environment Variables in Replit

In Replit → **Secrets**:

* `USE_UWM_TUNNEL` = `true`
* `UWM_TUNNEL_BASE_URL` = `https://localhost:9000`  *(optional; default is fine)*
* `UWM_TUNNEL_LOCAL_PORT` = `9000` *(optional; default is fine)*
* `SSH_HOST` = `4.227.184.143`
* `SSH_USER` = `vg-stg-user`

### 3.2 Handle the SSH key on Replit

Replit secrets can’t directly be used as a file unless you write them to disk at startup.

Do this:

1. Add secret: `SSH_KEY_PEM` = `-----BEGIN OPENSSH PRIVATE KEY-----...`

2. In `server/index.ts` (before starting tunnel), write it:

```ts
import fs from "fs";

if (process.env.SSH_KEY_PEM) {
  fs.mkdirSync(".ssh", { recursive: true });
  fs.writeFileSync(".ssh/valargen-staging_key.pem", process.env.SSH_KEY_PEM);
  fs.chmodSync(".ssh/valargen-staging_key.pem", 0o600);
}
```

And set:

* `SSH_KEY_PATH` = `.ssh/valargen-staging_key.pem`

---

## 4) Quick sanity checks you should see

When you run:

* The tunnel starts (no immediate errors)
* Auth endpoint now returns JSON (or at least an API-style JSON error)

If tunnel fails, your logs should show:

* ssh binary missing
* key permission issue
* host unreachable / auth failed

Paste that error if it happens and I’ll tell you the exact fix.

---

## 5) Why this fixes the Cloudflare “OOPS!” page

Because now **UWM never sees Replit’s IP**.
It sees the Azure VM’s outbound IP (the one UWM whitelisted).

---

If you want, I can also package these edits into a patched ZIP for you to download — but you can apply the steps above directly and it should work.
