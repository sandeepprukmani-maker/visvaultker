# fetch_token.py
import json
import os
import httpx
from dotenv import load_dotenv
from datetime import datetime
from dataclasses import dataclass, field, asdict

load_dotenv(override=True)


@dataclass
class OAuthConfig:
    token_url: str
    client_id: str
    client_secret: str
    grant_type: str
    scope: str
    early_refresh_seconds: int = field(default=300, repr=False)

    def payload(self):
        return {
            "grant_type": self.grant_type,
            "client_id": self.client_id,
            "client_secret": self.client_secret,
            "scope": self.scope,
        }


class OAuthTokenFetcher:
    def __init__(self, cfg: OAuthConfig):
        self.cfg = cfg
        self.token = None
        self.refresh_after = 0
        self.fetch_token()

    def fetch_token(self):
        response = httpx.post(
            self.cfg.token_url,
            data=self.cfg.payload(),
            headers={"Content-Type": "application/x-www-form-urlencoded"},
            timeout=10,
        )
        response.raise_for_status()
        data = response.json()
        self.token = data["access_token"]
        self.refresh_after = (
            datetime.now().timestamp()
            + data["expires_in"]
            - self.cfg.early_refresh_seconds
        )

    def get_token(self):
        if datetime.now().timestamp() > self.refresh_after:
            self.fetch_token()
        return self.token


def get_token_and_url():
    required = [
        "OAUTH_TOKEN_URL",
        "OAUTH_CLIENT_ID",
        "OAUTH_CLIENT_SECRET",
        "OAUTH_GRANT_TYPE",
        "OAUTH_SCOPE",
        "GM_BASE_URL",
    ]
    missing = [v for v in required if not os.getenv(v)]
    if missing:
        raise EnvironmentError(f"Missing env vars: {', '.join(missing)}")

    cfg = OAuthConfig(
        token_url=os.environ["OAUTH_TOKEN_URL"],
        client_id=os.environ["OAUTH_CLIENT_ID"],
        client_secret=os.environ["OAUTH_CLIENT_SECRET"],
        grant_type=os.environ["OAUTH_GRANT_TYPE"],
        scope=os.environ["OAUTH_SCOPE"],
    )

    token = OAuthTokenFetcher(cfg).get_token()
    base_url = os.environ["GM_BASE_URL"]

    return {"apiKey": token, "baseURL": base_url}


if __name__ == "__main__":
    try:
        result = get_token_and_url()
        print(json.dumps(result))
    except Exception as e:
        print(json.dumps({"error": str(e)}))
        exit(1)


// stagehand.ts
import { spawn } from "child_process";
import { Stagehand } from "@browserbasehq/stagehand";

/** Run Python script and get JSON result */
async function fetchTokenFromPython(): Promise<{ apiKey: string; baseURL: string }> {
  return new Promise((resolve, reject) => {
    const py = spawn("python", ["fetch_token.py"]);

    let data = "";
    let error = "";

    py.stdout.on("data", (chunk) => (data += chunk.toString()));
    py.stderr.on("data", (chunk) => (error += chunk.toString()));

    py.on("close", (code) => {
      if (code !== 0) {
        reject(new Error(`Python exited with code ${code}: ${error}`));
      } else {
        try {
          const parsed = JSON.parse(data.trim());
          if (parsed.error) reject(new Error(parsed.error));
          else resolve(parsed);
        } catch (err) {
          reject(new Error(`Invalid JSON from Python: ${data}`));
        }
      }
    });
  });
}

async function main() {
  console.log("ðŸ”„ Fetching OAuth token from Python...");
  const { apiKey, baseURL } = await fetchTokenFromPython();
  console.log("âœ… Token retrieved successfully.");

  const stagehand = new Stagehand({
    env: "BROWSERBASE",
    model: {
      modelName: "gpt-4o",
      apiKey,
      baseURL,
    },
  });

  await stagehand.init();

  const page = stagehand.context.pages()[0];
  await page.goto("https://www.google.com");

  await stagehand.act("type 'dog' into the search box");
  await stagehand.act("press Enter");

  await page.waitForLoadState("networkidle");

  console.log("âœ… Search completed!");
  await stagehand.close();
}

main().catch(console.error);


pip install httpx python-dotenv
npm install @browserbasehq/stagehand
npm install --save-dev typescript @types/node

OAUTH_TOKEN_URL=https://auth.example.com/oauth2/token
OAUTH_CLIENT_ID=my-client-id
OAUTH_CLIENT_SECRET=my-client-secret
OAUTH_GRANT_TYPE=client_credentials
OAUTH_SCOPE=https://api.example.com/.default
GM_BASE_URL=https://gateway.example.com/v1

npx tsx stagehand.ts
