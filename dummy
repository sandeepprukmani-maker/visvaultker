import { spawn } from "child_process";
import { Stagehand, AISdkClient } from "browserbasehq/stagehand";
import { createOpenAI } from "@ai-sdk/openai";

// ğŸ”¹ Step 1: Fetch token from Python
async function fetchOAuthToken(): Promise<string> {
  return new Promise((resolve, reject) => {
    const python = spawn("python", ["fetch_token.py"]);

    let output = "";
    let errorOutput = "";

    python.stdout.on("data", (data) => {
      output += data.toString();
    });

    python.stderr.on("data", (data) => {
      errorOutput += data.toString();
    });

    python.on("close", (code) => {
      if (code !== 0) {
        reject(new Error(`fetch_token.py failed: ${errorOutput}`));
      } else {
        try {
          const result = JSON.parse(output.trim());
          if (result.error) reject(new Error(result.error));
          else resolve(result.api_key);
        } catch (err) {
          reject(new Error(`Failed to parse fetch_token.py output: ${output}`));
        }
      }
    });
  });
}

// ğŸ”¹ Step 2: Main logic
async function main() {
  console.log("ğŸ”‘ Fetching API key...");
  const apiKey = await fetchOAuthToken();

  console.log("âš™ï¸ Setting up custom LLM provider...");
  const customProvider = createOpenAI({
    apiKey,
    baseURL: "",
  });

  const llmClient = new AISdkClient({
    model: customProvider("gpt-4o-1-2025-04-14-eastus-dz"), // Change to your actual model name
  });

  console.log("ğŸš€ Launching Stagehand...");
  const stagehand = new Stagehand({
    env: "BROWSERBASE",
    llmClient,
  });

  console.log("ğŸŒ Opening Google...");
  await stagehand.page.goto("https://www.google.com");

  console.log("ğŸ” Searching for 'dog'...");
  await stagehand.act({
    action: "type",
    target: { role: "textbox", name: "Search" },
    text: "dog",
  });

  await stagehand.act({
    action: "press",
    target: { role: "textbox", name: "Search" },
    key: "Enter",
  });

  await stagehand.page.waitForTimeout(3000);

  console.log("âœ… Search completed.");
  await stagehand.close();
}

// ğŸ”¹ Execute
main().catch((err) => console.error("âŒ Error:", err));
