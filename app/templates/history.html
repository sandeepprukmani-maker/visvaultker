{% extends "base.html" %}

{% block title %}Execution History{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">Execution History</h1>
    <p class="page-description">View your past automation executions and results</p>
</div>

<div class="top-bar">
    <button class="btn btn-danger" id="delete-all-btn">
        <span class="btn-icon"><i data-feather="trash-2"></i></span>
        Delete All
    </button>
    <button class="btn btn-primary" id="refresh-btn">
        <span class="btn-icon"><i data-feather="refresh-cw"></i></span>
        Refresh
    </button>
</div>

<div id="history-container">
    <div class="empty-state" id="empty-state">
        <div class="empty-state-icon"><i data-feather="clipboard"></i></div>
        <p>No executions yet</p>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
<script>
const HISTORY_API = '/api/history';

let currentPage = 1;
let totalPages = 1;
let loadedHistory = {};  // Cache for loaded history details

async function loadHistory(page = 1) {
    try {
        const response = await fetch(`${HISTORY_API}?page=${page}&per_page=10`);
        const data = await response.json();
        
        if (data.success) {
            // Load full details for each history item
            for (const item of data.history) {
                if (!loadedHistory[item.id]) {
                    const detailResponse = await fetch(`${HISTORY_API}/${item.id}`);
                    const detailData = await detailResponse.json();
                    if (detailData.success) {
                        loadedHistory[item.id] = detailData.history;
                    }
                }
            }
            
            displayHistory(data.history);
            currentPage = data.page;
            totalPages = data.pages;
            
            if (data.history.length === 0) {
                document.getElementById('empty-state').style.display = 'block';
            } else {
                document.getElementById('empty-state').style.display = 'none';
            }
        } else {
            console.error('Failed to load history:', data.message);
        }
    } catch (error) {
        console.error('Error loading history:', error);
    }
}

function displayHistory(history) {
    const container = document.getElementById('history-container');
    
    // Clear all history cards but keep the empty state
    const historyCards = container.querySelectorAll('.history-card');
    historyCards.forEach(card => card.remove());
    
    if (history.length === 0) {
        return;
    }
    
    const historyHTML = history.map(item => {
        const fullItem = loadedHistory[item.id] || item;
        const date = new Date(item.created_at);
        const formattedDate = date.toLocaleString();
        const statusClass = item.success ? 'success' : 'error';
        const statusIcon = item.success ? 'check-circle' : 'x-circle';
        const modeIcon = item.headless ? 'eye-off' : 'eye';
        const engineIcon = item.engine.includes('browser_use') ? 'cpu' : 'code';
        
        // Parse screenshots array
        let screenshots = [];
        if (fullItem.screenshots && Array.isArray(fullItem.screenshots)) {
            screenshots = fullItem.screenshots;
        }
        
        // Parse execution logs
        let executionLogs = [];
        try {
            if (fullItem.execution_logs) {
                executionLogs = JSON.parse(fullItem.execution_logs);
            }
        } catch (e) {
            executionLogs = [];
        }
        
        return `
            <div class="history-card" style="margin-bottom: 30px; border-radius: 12px; overflow: hidden;">
                <div class="history-header" style="background: var(--panel-bg); padding: 16px; border-bottom: 1px solid var(--border);">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div class="history-meta">
                            <div class="history-status ${statusClass}" style="display: inline-flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                <i data-feather="${statusIcon}"></i>
                                <span>${item.success ? 'Success' : 'Failed'}</span>
                            </div>
                            <div class="history-date" style="color: var(--text-secondary); font-size: 0.9rem;">${formattedDate}</div>
                            <div class="history-info" style="display: flex; gap: 12px; margin-top: 12px; flex-wrap: wrap;">
                                <div class="info-badge" style="display: inline-flex; align-items: center; gap: 6px; padding: 4px 12px; background: var(--bg-secondary); border-radius: 12px; font-size: 0.85rem;">
                                    <i data-feather="${modeIcon}" style="width: 14px; height: 14px;"></i>
                                    <span>${item.headless ? 'Headless' : 'Headful'}</span>
                                </div>
                                <div class="info-badge" style="display: inline-flex; align-items: center; gap: 6px; padding: 4px 12px; background: var(--bg-secondary); border-radius: 12px; font-size: 0.85rem;">
                                    <i data-feather="${engineIcon}" style="width: 14px; height: 14px;"></i>
                                    <span>Browser Use</span>
                                </div>
                                ${item.iterations ? `<div class="info-badge" style="display: inline-flex; align-items: center; gap: 6px; padding: 4px 12px; background: var(--bg-secondary); border-radius: 12px; font-size: 0.85rem;"><span>${item.iterations} steps</span></div>` : ''}
                            </div>
                        </div>
                        <button class="btn btn-secondary btn-sm" onclick="deleteHistoryItem(${item.id})" style="margin-left: auto;">
                            <span class="btn-icon"><i data-feather="trash-2"></i></span>
                        </button>
                    </div>
                    
                    <div class="history-prompt" style="margin-top: 16px; padding: 12px; background: var(--bg-secondary); border-radius: 8px;">
                        <strong style="color: var(--text-primary);">Prompt:</strong>
                        <p style="margin: 8px 0 0 0; color: var(--text-secondary);">${escapeHtml(item.prompt)}</p>
                    </div>
                    
                    ${item.error_message ? `
                        <div class="history-error" style="margin-top: 12px; padding: 12px; background: var(--error-bg); border-radius: 8px; color: var(--error-text);">
                            <strong>Error:</strong>
                            <p style="margin: 8px 0 0 0;">${escapeHtml(item.error_message)}</p>
                        </div>
                    ` : ''}
                </div>
                
                <!-- Dashboard-style panels for this history item -->
                <div style="padding: 20px; background: var(--bg-primary);">
                    ${fullItem.generated_script || fullItem.healed_script ? `
                        <!-- Scripts section -->
                        <div class="grid-2" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 20px;">
                            ${fullItem.generated_script ? `
                                <div class="panel">
                                    <div class="panel-header">
                                        <span class="panel-icon"><i data-feather="code"></i></span>
                                        <span class="panel-title">Generated Script</span>
                                        <span class="badge badge-smart" style="margin-left: 8px; padding: 2px 8px; background: var(--primary); color: white; border-radius: 12px; font-size: 0.75rem;">REUSABLE</span>
                                        <button class="btn btn-sm btn-icon" onclick="copyToClipboard(\`${escapeHtml(fullItem.generated_script).replace(/`/g, '\\`')}\`)" style="margin-left: auto;" title="Copy to clipboard">
                                            <i data-feather="copy"></i>
                                        </button>
                                    </div>
                                    <div class="output-panel code-panel" style="max-height: 400px; overflow-y: auto;">
                                        <pre style="margin: 0;"><code class="language-python">${escapeHtml(fullItem.generated_script)}</code></pre>
                                    </div>
                                </div>
                            ` : ''}
                            
                            ${fullItem.healed_script ? `
                                <div class="panel">
                                    <div class="panel-header">
                                        <span class="panel-icon"><i data-feather="refresh-cw"></i></span>
                                        <span class="panel-title">Healed Script</span>
                                        <span class="badge badge-smart" style="margin-left: 8px; padding: 2px 8px; background: var(--success); color: white; border-radius: 12px; font-size: 0.75rem;">SMART</span>
                                        <button class="btn btn-sm btn-icon" onclick="copyToClipboard(\`${escapeHtml(fullItem.healed_script).replace(/`/g, '\\`')}\`)" style="margin-left: auto;" title="Copy to clipboard">
                                            <i data-feather="copy"></i>
                                        </button>
                                    </div>
                                    <div class="output-panel code-panel" style="max-height: 400px; overflow-y: auto;">
                                        <pre style="margin: 0;"><code class="language-python">${escapeHtml(fullItem.healed_script)}</code></pre>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    ` : ''}
                    
                    <!-- Screenshots and Logs section -->
                    <div class="grid-2" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                        <div class="panel">
                            <div class="panel-header">
                                <span class="panel-icon"><i data-feather="camera"></i></span>
                                <span class="panel-title">Screenshots</span>
                                ${screenshots.length > 0 ? `<span class="badge" style="margin-left: 8px; padding: 2px 8px; background: var(--bg-secondary); border-radius: 12px; font-size: 0.75rem;">${screenshots.length}</span>` : ''}
                            </div>
                            <div class="output-panel" style="max-height: 500px; overflow-y: auto;">
                                ${screenshots.length > 0 ? screenshots.map((screenshot, index) => `
                                    <div style="margin-bottom: 15px; padding: 10px; border: 1px solid var(--border); border-radius: 4px; background: var(--panel-bg);">
                                        <div style="text-align: center;">
                                            <div style="margin-bottom: 8px; color: var(--text-secondary); font-size: 0.9rem; font-weight: 600;">Step ${index + 1}</div>
                                            <img src="${screenshot}" alt="Step ${index + 1} Screenshot" 
                                                 style="max-width: 100%; height: auto; border-radius: 4px; cursor: pointer; border: 1px solid var(--border);" 
                                                 onclick="window.open('${screenshot}', '_blank')"
                                                 onerror="this.parentElement.innerHTML='<div style=\\'color: var(--error-text); padding: 20px;\\'>Screenshot not available</div>'">
                                        </div>
                                    </div>
                                `).join('') : '<div class="empty-state"><div>No screenshots available</div></div>'}
                            </div>
                        </div>
                        
                        <div class="panel">
                            <div class="panel-header">
                                <span class="panel-icon"><i data-feather="list"></i></span>
                                <span class="panel-title">Execution Logs</span>
                                ${executionLogs.length > 0 ? `<span class="badge" style="margin-left: 8px; padding: 2px 8px; background: var(--bg-secondary); border-radius: 12px; font-size: 0.75rem;">${executionLogs.length} steps</span>` : ''}
                            </div>
                            <div class="output-panel" style="max-height: 500px; overflow-y: auto;">
                                ${executionLogs.length > 0 ? executionLogs.map((log, index) => {
                                    const logStr = typeof log === 'object' ? JSON.stringify(log, null, 2) : String(log);
                                    return `<div style="color: var(--success-text); margin: 3px 0;">âœ“ Step ${index + 1}: ${escapeHtml(logStr).substring(0, 200)}${logStr.length > 200 ? '...' : ''}</div>`;
                                }).join('') : '<div class="empty-state"><div>No logs available</div></div>'}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }).join('');
    
    // Insert history cards before the empty-state element
    const emptyState = document.getElementById('empty-state');
    emptyState.insertAdjacentHTML('beforebegin', historyHTML);
    feather.replace();
}

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Copy text to clipboard with feedback
async function copyToClipboard(text) {
    try {
        await navigator.clipboard.writeText(text);
        // Show success feedback
        const btn = event.target.closest('button');
        const originalHTML = btn.innerHTML;
        btn.innerHTML = '<i data-feather="check"></i>';
        feather.replace();
        setTimeout(() => {
            btn.innerHTML = originalHTML;
            feather.replace();
        }, 2000);
    } catch (error) {
        console.error('Failed to copy to clipboard:', error);
        alert('Failed to copy to clipboard');
    }
}

async function deleteHistoryItem(id) {
    if (!confirm('Are you sure you want to delete this execution?')) {
        return;
    }
    
    try {
        const response = await fetch(`${HISTORY_API}/${id}`, {
            method: 'DELETE'
        });
        const data = await response.json();
        
        if (data.success) {
            delete loadedHistory[id];  // Remove from cache
            loadHistory(currentPage);
        } else {
            alert('Failed to delete: ' + data.message);
        }
    } catch (error) {
        console.error('Error deleting item:', error);
        alert('Failed to delete item');
    }
}

async function deleteAllHistory() {
    if (!confirm('Are you sure you want to delete ALL execution history? This cannot be undone.')) {
        return;
    }
    
    try {
        const response = await fetch(HISTORY_API, {
            method: 'DELETE'
        });
        const data = await response.json();
        
        if (data.success) {
            loadedHistory = {};  // Clear cache
            loadHistory(1);
        } else {
            alert('Failed to delete: ' + data.message);
        }
    } catch (error) {
        console.error('Error deleting all:', error);
        alert('Failed to delete all history');
    }
}

document.getElementById('refresh-btn').addEventListener('click', () => {
    loadedHistory = {};  // Clear cache on refresh
    loadHistory(currentPage);
});

document.getElementById('delete-all-btn').addEventListener('click', deleteAllHistory);

loadHistory();
feather.replace();
</script>
{% endblock %}
