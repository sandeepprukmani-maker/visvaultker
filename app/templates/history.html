{% extends "base.html" %}

{% block title %}Execution History{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">Execution History</h1>
    <p class="page-description">View your past automation executions and results</p>
</div>

<div class="top-bar">
    <button class="btn btn-danger" id="delete-all-btn">
        <span class="btn-icon"><i data-feather="trash-2"></i></span>
        Delete All
    </button>
    <button class="btn btn-primary" id="refresh-btn">
        <span class="btn-icon"><i data-feather="refresh-cw"></i></span>
        Refresh
    </button>
</div>

<div id="history-container">
    <div class="empty-state" id="empty-state">
        <div class="empty-state-icon"><i data-feather="clipboard"></i></div>
        <p>No executions yet</p>
    </div>
</div>

<div id="detail-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">Execution Details</h2>
            <button class="modal-close" id="close-modal">
                <i data-feather="x"></i>
            </button>
        </div>
        <div class="modal-body" id="modal-body">
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
<script>
const HISTORY_API = '/api/history';

let currentPage = 1;
let totalPages = 1;

async function loadHistory(page = 1) {
    try {
        const response = await fetch(`${HISTORY_API}?page=${page}&per_page=20`);
        const data = await response.json();
        
        if (data.success) {
            displayHistory(data.history);
            currentPage = data.page;
            totalPages = data.pages;
            
            if (data.history.length === 0) {
                document.getElementById('empty-state').style.display = 'block';
            } else {
                document.getElementById('empty-state').style.display = 'none';
            }
        } else {
            console.error('Failed to load history:', data.message);
        }
    } catch (error) {
        console.error('Error loading history:', error);
    }
}

function displayHistory(history) {
    const container = document.getElementById('history-container');
    
    if (history.length === 0) {
        return;
    }
    
    const historyHTML = history.map(item => {
        const date = new Date(item.created_at);
        const formattedDate = date.toLocaleString();
        const statusClass = item.success ? 'success' : 'error';
        const statusIcon = item.success ? 'check-circle' : 'x-circle';
        const modeIcon = item.headless ? 'eye-off' : 'eye';
        const engineIcon = item.engine.includes('browser_use') ? 'cpu' : 'code';
        
        return `
            <div class="history-card">
                <div class="history-header">
                    <div class="history-meta">
                        <div class="history-status ${statusClass}">
                            <i data-feather="${statusIcon}"></i>
                            <span>${item.success ? 'Success' : 'Failed'}</span>
                        </div>
                        <div class="history-date">${formattedDate}</div>
                    </div>
                    <button class="btn btn-secondary btn-sm" onclick="deleteHistoryItem(${item.id})">
                        <span class="btn-icon"><i data-feather="trash-2"></i></span>
                    </button>
                </div>
                
                <div class="history-info">
                    <div class="info-badge">
                        <i data-feather="${modeIcon}"></i>
                        <span>${item.headless ? 'Headless' : 'Headful'}</span>
                    </div>
                    <div class="info-badge">
                        <i data-feather="${engineIcon}"></i>
                        <span>${item.engine === 'browser_use' ? 'Browser Use' : item.engine === 'browser_use_optimized' ? 'Browser Use (Optimized)' : item.engine === 'playwright_mcp' ? 'Playwright MCP' : item.engine}</span>
                    </div>
                    ${item.iterations ? `<div class="info-badge"><span>${item.iterations} steps</span></div>` : ''}
                </div>
                
                <div class="history-prompt">
                    <strong>Prompt:</strong>
                    <p>${escapeHtml(item.prompt)}</p>
                </div>
                
                ${item.error_message ? `
                    <div class="history-error">
                        <strong>Error:</strong>
                        <p>${escapeHtml(item.error_message)}</p>
                    </div>
                ` : ''}
                
                <button class="btn btn-primary btn-block" onclick="viewDetails(${item.id})">
                    <span class="btn-icon"><i data-feather="eye"></i></span>
                    View Full Details
                </button>
            </div>
        `;
    }).join('');
    
    container.innerHTML = historyHTML + '<div id="empty-state" class="empty-state" style="display: none;"><div class="empty-state-icon"><i data-feather="clipboard"></i></div><p>No executions yet</p></div>';
    feather.replace();
}

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

async function viewDetails(id) {
    try {
        const response = await fetch(`${HISTORY_API}/${id}`);
        const data = await response.json();
        
        if (data.success) {
            const item = data.history;
            const modalBody = document.getElementById('modal-body');
            
            const hasData = item.generated_script || item.healed_script || (item.screenshots && item.screenshots.length > 0) || item.execution_logs;
            
            modalBody.innerHTML = `
                <div class="detail-grid">
                    ${item.healed_script && item.generated_script ? `
                        <div style="margin-bottom: 16px; padding: 12px; background: var(--info-bg, #d1ecf1); border-radius: 8px; color: var(--info-text, #0c5460); border-left: 4px solid var(--info-border, #bee5eb);">
                            <strong>ℹ️ Note:</strong> When executing, the healed script will be used automatically since it's the most recent working version.
                        </div>
                    ` : ''}
                    
                    ${item.generated_script ? `
                        <div class="detail-section">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                <h3 style="margin: 0;"><i data-feather="file-text"></i> Generated Script</h3>
                                <div style="display: flex; gap: 8px;">
                                    <button class="btn btn-sm btn-success" onclick="executeScript(${item.id}, event)" title="${item.healed_script ? 'Execute healed script (takes precedence)' : 'Execute script with auto-healing'}">
                                        <i data-feather="play"></i> Execute
                                    </button>
                                    <button class="btn btn-sm btn-secondary" onclick="copyCode(${item.id}, 'generated')" title="Copy to clipboard">
                                        <i data-feather="copy"></i> Copy
                                    </button>
                                    <button class="btn btn-sm btn-primary" onclick="downloadCode(${item.id})" title="Download as .py file">
                                        <i data-feather="download"></i> Download
                                    </button>
                                </div>
                            </div>
                            <div class="output-panel">
                                <pre><code id="generated-code-${item.id}">${escapeHtml(item.generated_script)}</code></pre>
                            </div>
                        </div>
                    ` : ''}
                    
                    ${item.healed_script ? `
                        <div class="detail-section">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                <h3 style="margin: 0;"><i data-feather="refresh-cw"></i> Healed Script (Active Version)</h3>
                                <button class="btn btn-sm btn-secondary" onclick="copyCode(${item.id}, 'healed')" title="Copy to clipboard">
                                    <i data-feather="copy"></i> Copy
                                </button>
                            </div>
                            <div class="output-panel">
                                <pre><code id="healed-code-${item.id}">${escapeHtml(item.healed_script)}</code></pre>
                            </div>
                        </div>
                    ` : ''}
                    
                    ${item.screenshots && item.screenshots.length > 0 ? `
                        <div class="detail-section">
                            <h3><i data-feather="camera"></i> Screenshots (${item.screenshots.length})</h3>
                            <div class="output-panel" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 16px;">
                                ${item.screenshots.map((screenshot, index) => `
                                    <div style="border: 1px solid var(--border-color); border-radius: 8px; overflow: hidden;">
                                        <div style="padding: 8px; background: var(--bg-secondary); font-weight: 500; font-size: 0.9rem;">
                                            Screenshot ${index + 1}
                                        </div>
                                        <img src="${screenshot}" alt="Screenshot ${index + 1}" style="width: 100%; display: block; cursor: pointer;" onclick="window.open('${screenshot}', '_blank')">
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    ${item.execution_logs ? `
                        <div class="detail-section">
                            <h3><i data-feather="list"></i> Execution Logs</h3>
                            <div class="output-panel">
                                <pre>${formatLogs(item.execution_logs)}</pre>
                            </div>
                        </div>
                    ` : ''}
                    
                    ${!hasData ? `
                        <div class="empty-state">
                            <div class="empty-state-icon"><i data-feather="info"></i></div>
                            <p>No additional details available for this execution.</p>
                            <p style="color: var(--text-muted); font-size: 0.9rem; margin-top: 8px;">
                                Engine: ${item.engine}<br>
                                Status: ${item.success ? 'Success' : 'Failed'}<br>
                                ${item.error_message ? `Error: ${escapeHtml(item.error_message)}` : ''}
                            </p>
                        </div>
                    ` : ''}
                </div>
            `;
            
            document.getElementById('detail-modal').style.display = 'flex';
            feather.replace();
        }
    } catch (error) {
        console.error('Error loading details:', error);
    }
}

function formatLogs(logsJson) {
    try {
        const logs = JSON.parse(logsJson);
        if (Array.isArray(logs)) {
            return logs.map((log, i) => `${i + 1}. ${escapeHtml(JSON.stringify(log, null, 2))}`).join('\n\n');
        }
        return escapeHtml(JSON.stringify(logs, null, 2));
    } catch {
        return escapeHtml(logsJson);
    }
}

async function deleteHistoryItem(id) {
    if (!confirm('Are you sure you want to delete this execution?')) {
        return;
    }
    
    try {
        const response = await fetch(`${HISTORY_API}/${id}`, {
            method: 'DELETE'
        });
        const data = await response.json();
        
        if (data.success) {
            loadHistory(currentPage);
        } else {
            alert('Failed to delete: ' + data.message);
        }
    } catch (error) {
        console.error('Error deleting item:', error);
        alert('Failed to delete item');
    }
}

async function deleteAllHistory() {
    if (!confirm('Are you sure you want to delete ALL execution history? This cannot be undone.')) {
        return;
    }
    
    try {
        const response = await fetch(HISTORY_API, {
            method: 'DELETE'
        });
        const data = await response.json();
        
        if (data.success) {
            loadHistory(1);
        } else {
            alert('Failed to delete: ' + data.message);
        }
    } catch (error) {
        console.error('Error deleting all:', error);
        alert('Failed to delete all history');
    }
}

document.getElementById('refresh-btn').addEventListener('click', () => {
    loadHistory(currentPage);
});

document.getElementById('delete-all-btn').addEventListener('click', deleteAllHistory);

document.getElementById('close-modal').addEventListener('click', () => {
    document.getElementById('detail-modal').style.display = 'none';
});

window.addEventListener('click', (e) => {
    const modal = document.getElementById('detail-modal');
    if (e.target === modal) {
        modal.style.display = 'none';
    }
});

// Copy code to clipboard
async function copyCode(id, type) {
    try {
        const codeElement = document.getElementById(`${type}-code-${id}`);
        const code = codeElement.textContent;
        
        await navigator.clipboard.writeText(code);
        
        // Show success feedback
        const btn = event.target.closest('button');
        const originalHTML = btn.innerHTML;
        btn.innerHTML = '<i data-feather="check"></i> Copied!';
        feather.replace();
        
        setTimeout(() => {
            btn.innerHTML = originalHTML;
            feather.replace();
        }, 2000);
    } catch (error) {
        console.error('Failed to copy code:', error);
        alert('Failed to copy code to clipboard');
    }
}

// Download code as file
function downloadCode(id) {
    window.location.href = `${API_BASE}/code/download/${id}`;
}

// Execute script with auto-healing
async function executeScript(id, event) {
    const btn = event.target.closest('button');
    const originalHTML = btn.innerHTML;
    
    try {
        // Show loading state
        btn.disabled = true;
        btn.innerHTML = '<i data-feather="loader"></i> Executing...';
        feather.replace();
        
        const response = await fetch(`${HISTORY_API}/${id}/execute`, {
            method: 'POST'
        });
        const data = await response.json();
        
        if (data.success) {
            if (data.healing_needed) {
                // Script was healed - inject healed script section into the modal
                btn.innerHTML = '<i data-feather="check-circle"></i> Healed!';
                feather.replace();
                
                // Add healed script section to the modal if not already present
                const modalBody = document.getElementById('modal-body');
                const detailGrid = modalBody.querySelector('.detail-grid');
                
                // Remove any existing healed script section
                const existingHealedSection = detailGrid.querySelector('.healed-script-section');
                if (existingHealedSection) {
                    existingHealedSection.remove();
                }
                
                // Insert healed script section after generated script
                const generatedSection = detailGrid.querySelector('.detail-section');
                if (generatedSection && data.healed_script) {
                    const healedSection = document.createElement('div');
                    healedSection.className = 'detail-section healed-script-section';
                    healedSection.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <h3 style="margin: 0;"><i data-feather="refresh-cw"></i> Healed Script</h3>
                            <button class="btn btn-sm btn-secondary" onclick="copyHealedCode(${id})" title="Copy to clipboard">
                                <i data-feather="copy"></i> Copy
                            </button>
                        </div>
                        <div class="output-panel">
                            <pre><code id="healed-code-${id}">${escapeHtml(data.healed_script)}</code></pre>
                        </div>
                        <div style="margin-top: 12px; padding: 12px; background: var(--success-bg, #d4edda); border-radius: 8px; color: var(--success-text, #155724);">
                            <strong>✅ Script Healed Successfully</strong>
                            <p style="margin: 8px 0 0 0; font-size: 0.9rem;">
                                Healing attempts: ${data.healing_attempts}<br>
                                Healing steps: ${data.healing_steps || 0}
                            </p>
                            <p style="margin: 8px 0 0 0; font-size: 0.85rem; opacity: 0.9;">
                                The healed version will become the new Generated Script when you reopen this history item.
                            </p>
                        </div>
                    `;
                    generatedSection.after(healedSection);
                    feather.replace();
                }
                
                setTimeout(() => {
                    btn.innerHTML = originalHTML;
                    btn.disabled = false;
                    feather.replace();
                }, 3000);
            } else {
                // Script passed without healing
                btn.innerHTML = '<i data-feather="check-circle"></i> Passed!';
                feather.replace();
                
                // Show success banner
                const modalBody = document.getElementById('modal-body');
                const detailGrid = modalBody.querySelector('.detail-grid');
                const existingBanner = detailGrid.querySelector('.success-banner');
                if (existingBanner) existingBanner.remove();
                
                const banner = document.createElement('div');
                banner.className = 'success-banner';
                banner.style.cssText = 'margin-bottom: 16px; padding: 12px; background: var(--success-bg, #d4edda); border-radius: 8px; color: var(--success-text, #155724);';
                banner.innerHTML = '<strong>✅ Script Passed!</strong><p style="margin: 8px 0 0 0;">The script executed successfully without any issues.</p>';
                detailGrid.insertBefore(banner, detailGrid.firstChild);
                
                setTimeout(() => {
                    banner.remove();
                    btn.innerHTML = originalHTML;
                    btn.disabled = false;
                    feather.replace();
                }, 5000);
            }
        } else {
            // Execution/healing failed
            btn.innerHTML = '<i data-feather="x-circle"></i> Failed';
            feather.replace();
            
            // Show error banner
            const modalBody = document.getElementById('modal-body');
            const detailGrid = modalBody.querySelector('.detail-grid');
            const existingBanner = detailGrid.querySelector('.error-banner');
            if (existingBanner) existingBanner.remove();
            
            const banner = document.createElement('div');
            banner.className = 'error-banner';
            banner.style.cssText = 'margin-bottom: 16px; padding: 12px; background: var(--error-bg, #f8d7da); border-radius: 8px; color: var(--error-text, #721c24);';
            banner.innerHTML = `<strong>❌ Execution Failed</strong><p style="margin: 8px 0 0 0;">${escapeHtml(data.message)}</p><p style="margin: 8px 0 0 0; font-size: 0.85rem; opacity: 0.9;">The script may have issues that couldn't be automatically healed.</p>`;
            detailGrid.insertBefore(banner, detailGrid.firstChild);
            
            setTimeout(() => {
                banner.remove();
                btn.innerHTML = originalHTML;
                btn.disabled = false;
                feather.replace();
            }, 5000);
        }
    } catch (error) {
        console.error('Error executing script:', error);
        btn.innerHTML = '<i data-feather="alert-circle"></i> Error';
        feather.replace();
        
        alert('Failed to execute script. Please try again.');
        
        setTimeout(() => {
            btn.innerHTML = originalHTML;
            btn.disabled = false;
            feather.replace();
        }, 2000);
    }
}

// Copy healed code to clipboard
async function copyHealedCode(id) {
    try {
        const codeElement = document.getElementById(`healed-code-${id}`);
        const code = codeElement.textContent;
        
        await navigator.clipboard.writeText(code);
        
        // Show success feedback
        const btn = event.target.closest('button');
        const originalHTML = btn.innerHTML;
        btn.innerHTML = '<i data-feather="check"></i> Copied!';
        feather.replace();
        
        setTimeout(() => {
            btn.innerHTML = originalHTML;
            feather.replace();
        }, 2000);
    } catch (error) {
        console.error('Failed to copy code:', error);
        alert('Failed to copy code to clipboard');
    }
}

loadHistory();
feather.replace();
</script>
{% endblock %}
